!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("llsRecorder",[],t):"object"==typeof exports?exports.llsRecorder=t():e.llsRecorder=t()}(this,function(){return function(e){function t(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,r){"use strict";function n(e,t){console.log(e+" "+(t||""))}function o(e){var t=e.secret,r=e.appId;return new Promise(function(e,o){return t?r?void i().then(function(o){var a=l.createMediaStreamSource(o);g=new f.default(a,{secret:t,appId:r,serverUrl:d}),n("Recorder initialised."),e()}).catch(function(e){o(e)}):void o(new Error("appId is empty")):void o(new Error("secret is empty"))})}function a(e){if(!g){throw new Error("Recorder is not initialised")}return g.record(e)}function u(){return g.stop()}function s(e){return g.reupload(e)}function i(){try{window.AudioContext=window.AudioContext||window.webkitAudioContext,navigator.mediaDevices||(navigator.mediaDevices={}),"function"!==navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(e){var t=navigator.getUserMedia||navigator.webkitGetUserMedia;return t?new Promise(function(r,n){t.call(navigator,e,r,n)}):Promise.reject(new Error("getUserMedia is not supported in this browser"))}),l=new AudioContext,n("Audio context set up."),n("navigator.getUserMedia "+(navigator.mediaDevices.getUserMedia?"available.":"not present!"))}catch(e){return Promise.reject(e)}return navigator.mediaDevices.getUserMedia({audio:!0,video:!1})}var c=r(1),f=function(e){return e&&e.__esModule?e:{default:e}}(c),d="wss://openapi.llsapp.com/openapi/stream/upload",l=void 0,g=void 0;e.exports={init:o,startRecord:a,stopRecord:u,reupload:s}},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(2),u=function(e){return e&&e.__esModule?e:{default:e}}(a),s=r(4),i=function(){function e(t){var r=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,e),this.recording=!1,this.callbacks={exportAudio:[],getResult:[]};var a=o.bufferLen||4096;this.serverUrl=o.serverUrl,this.secret=o.secret,this.appId=o.appId,this.context=t.context;var s=(this.context.createScriptProcessor||this.context.createJavaScriptNode).call(this.context,a,1,1);this.worker=new u.default,this.worker.onmessage=function(e){var t=e.data,n=t.command,o=t.data;if(r.recording=!1,"websocketError"===n)throw new Error("websocket 连接失败");if("websocketInitSucc"===n?(r.recording=!0,r.initPromise.resolve()):"getResult"===n&&-20===o.status&&r.recording&&(r.recording=!1),r.callbacks[n]){var a=r.callbacks[n].pop();"function"==typeof a&&a(o)}},s.onaudioprocess=function(e){if(r.recording){var t=e.inputBuffer.getChannelData(0);r.worker.postMessage({command:"record",buffer:t})}},t.connect(s),s.connect(this.context.destination)}return o(e,[{key:"record",value:function(e){var t=e.question,r=e.getAudio,n=e.getResult;return this.recording=!0,this.callbacks.exportAudio.push(r),this.callbacks.getResult.push(n),this.initPromise=(0,s.createDefaultPromise)(),this.worker.postMessage({command:"init",config:{secret:this.secret,serverUrl:this.serverUrl,appId:this.appId,recordItem:t,sampleRate:this.context.sampleRate}}),this.initPromise}},{key:"stop",value:function(){this.recording=!1,this.worker.postMessage({command:"stop"})}},{key:"reupload",value:function(e){var t=e.audioBlob,r=e.question,n=e.getResult;this.callbacks.getResult.push(n),this.worker.postMessage({command:"reupload",config:{audioBlob:t,recordItem:r,secret:this.secret,serverUrl:this.serverUrl,appId:this.appId,sampleRate:this.context.sampleRate}})}}]),e}();t.default=i},function(e,t,r){e.exports=function(){return r(3)('!function(e){function t(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var r={};t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=1)}([function(e,t){var r={utf8:{stringToBytes:function(e){return r.bin.stringToBytes(unescape(encodeURIComponent(e)))},bytesToString:function(e){return decodeURIComponent(escape(r.bin.bytesToString(e)))}},bin:{stringToBytes:function(e){for(var t=[],r=0;r<e.length;r++)t.push(255&e.charCodeAt(r));return t},bytesToString:function(e){for(var t=[],r=0;r<e.length;r++)t.push(String.fromCharCode(e[r]));return t.join("")}}};e.exports=r},function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function init(e){var t=e.secret,r=e.serverUrl,n=e.recordItem,o=e.appId;websocket=new WebSocket(r),recordBuffers=[],recordTotalLength=0,sampleRate=e.sampleRate,websocket.onmessage=onGetResult,websocket.onerror=function(e){self.postMessage({command:"websocketError",data:e})},websocket.onopen=function(){self.postMessage({command:"websocketInitSucc"}),sendHead(n,t,o)}}function record(e){var t=resample2(e);recordBuffers.push(t),recordTotalLength+=t.length,send(t)}function stop(){if(websocket&&1===websocket.readyState){sendEOF();var e=exportAudio();postMessage({command:"exportAudio",data:e})}}function reupload(e){var t=e.secret,r=e.serverUrl,n=e.recordItem,o=e.appId;websocket=new WebSocket(r),sampleRate=e.sampleRate,websocket.onmessage=onGetResult,websocket.onerror=function(e){postMessage({command:"websocketError",data:e})},websocket.onopen=function(){sendHead(n,t,o);var r=new FileReader;r.addEventListener("loadend",function(){var e=r.result;websocket.send(e),sendEOF()}),r.readAsArrayBuffer(e.audioBlob)}}function onGetResult(e){var t=new FileReader;t.addEventListener("loadend",function(){var e=t.result;try{var r=new DataView(e),n=r.getUint32(0),o=extractResult(e,n,4);postMessage({command:"getResult",data:(0,_getResult2.default)(o)})}catch(e){postMessage({command:"getResult",data:{status:-100,success:!1,msg:"服务器结果解析错误: "+e}})}}),t.readAsArrayBuffer(e.data)}function extractResult(resultBuffer,metaLen,metaStartPos){var bufView=new Uint8Array(resultBuffer),metaBufView=bufView.subarray(metaStartPos,metaStartPos+metaLen);return eval("("+String.fromCharCode.apply(null,metaBufView)+")")}function resample2(e){for(var t=0,r=sampleRate/OUTPUT_SAMPLE_RATE,n=Math.ceil(e.length*OUTPUT_SAMPLE_RATE/sampleRate),o=new Float32Array(n),a=0;a<n;a++)o[a]=e[Math.floor(t)],t+=r;return o}function sendHead(e,t,r){var n=(0,_getMeta2.default)(e,t,r),o=n.length,a=new ArrayBuffer(4+o),s=new DataView(a);s.setUint32(0,o,!1),writeString(s,4,n),websocket.send(a)}function send(e){if(1===websocket.readyState){var t=transformToPCM(e);websocket.send(t)}}function sendEOF(){var e=new ArrayBuffer(3),t=new Uint8Array(e);t[0]=69,t[1]=79,t[2]=83,1===websocket.readyState&&websocket.send(e)}function transformToPCM(e){var t=new ArrayBuffer(2*e.length);return floatTo16BitPCM(new DataView(t),0,e),t}function floatTo16BitPCM(e,t,r){for(var n=0;n<r.length;n++,t+=2){var o=Math.max(-1,Math.min(1,r[n]));e.setInt16(t,o<0?32768*o:32767*o,!0)}}function writeString(e,t,r){for(var n=0;n<r.length;n++)e.setUint8(t+n,r.charCodeAt(n))}function encodeWAV(e){var t=2*e.length,r=new ArrayBuffer(44+t),n=new DataView(r),o=OUTPUT_SAMPLE_RATE;return writeString(n,0,"RIFF"),n.setUint32(4,36+t,!0),writeString(n,8,"WAVE"),writeString(n,12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,1,!0),n.setUint32(24,o,!0),n.setUint32(28,4*o,!0),n.setUint16(32,2,!0),n.setUint16(34,16,!0),writeString(n,36,"data"),n.setUint32(40,t,!0),floatTo16BitPCM(n,44,e),n}function mergeBuffers(e,t){for(var r=new Float32Array(t),n=0,o=0;o<e.length;o++)r.set(e[o],n),n+=e[o].length;return r}function exportAudio(){var e=mergeBuffers(recordBuffers,recordTotalLength),t=encodeWAV(e);return new Blob([t],{type:"audio/wav"})}var _getMeta=__webpack_require__(2),_getMeta2=_interopRequireDefault(_getMeta),_getResult=__webpack_require__(6),_getResult2=_interopRequireDefault(_getResult),OUTPUT_SAMPLE_RATE=16e3,websocket=void 0,recordBuffers=void 0,recordTotalLength=void 0,sampleRate=void 0;self.addEventListener("message",function(e){switch(e.data.command){case"init":init(e.data.config);break;case"record":record(e.data.buffer);break;case"stop":stop();break;case"reupload":reupload(e.data.config)}})},function(e,t,r){"use strict";function n(e){for(var t="",r=0;r<e;r++)t+=c[Math.floor(16*Math.random())];return t}function o(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}))}function a(e,t,r){var a=Math.floor(Date.now()/1e3)+":"+n(8),u={item:s({},e,{quality:-1}),appID:r,salt:a},c=JSON.stringify(u);return o(c+";hash="+(0,i.default)(r+"+"+c+"+"+a+"+"+t))}Object.defineProperty(t,"__esModule",{value:!0});var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},u=r(3),i=function(e){return e&&e.__esModule?e:{default:e}}(u),c=[0,1,2,3,4,5,6,7,8,9,"a","b","c","d","e","f"];t.default=a},function(e,t,r){!function(){var t=r(4),n=r(0).utf8,o=r(5),a=r(0).bin,s=function(e,r){e.constructor==String?e=r&&"binary"===r.encoding?a.stringToBytes(e):n.stringToBytes(e):o(e)?e=Array.prototype.slice.call(e,0):Array.isArray(e)||(e=e.toString());for(var u=t.bytesToWords(e),i=8*e.length,c=1732584193,f=-271733879,l=-1732584194,d=271733878,g=0;g<u.length;g++)u[g]=16711935&(u[g]<<8|u[g]>>>24)|4278255360&(u[g]<<24|u[g]>>>8);u[i>>>5]|=128<<i%32,u[14+(i+64>>>9<<4)]=i;for(var p=s._ff,h=s._gg,m=s._hh,v=s._ii,g=0;g<u.length;g+=16){var b=c,w=f,_=l,y=d;c=p(c,f,l,d,u[g+0],7,-680876936),d=p(d,c,f,l,u[g+1],12,-389564586),l=p(l,d,c,f,u[g+2],17,606105819),f=p(f,l,d,c,u[g+3],22,-1044525330),c=p(c,f,l,d,u[g+4],7,-176418897),d=p(d,c,f,l,u[g+5],12,1200080426),l=p(l,d,c,f,u[g+6],17,-1473231341),f=p(f,l,d,c,u[g+7],22,-45705983),c=p(c,f,l,d,u[g+8],7,1770035416),d=p(d,c,f,l,u[g+9],12,-1958414417),l=p(l,d,c,f,u[g+10],17,-42063),f=p(f,l,d,c,u[g+11],22,-1990404162),c=p(c,f,l,d,u[g+12],7,1804603682),d=p(d,c,f,l,u[g+13],12,-40341101),l=p(l,d,c,f,u[g+14],17,-1502002290),f=p(f,l,d,c,u[g+15],22,1236535329),c=h(c,f,l,d,u[g+1],5,-165796510),d=h(d,c,f,l,u[g+6],9,-1069501632),l=h(l,d,c,f,u[g+11],14,643717713),f=h(f,l,d,c,u[g+0],20,-373897302),c=h(c,f,l,d,u[g+5],5,-701558691),d=h(d,c,f,l,u[g+10],9,38016083),l=h(l,d,c,f,u[g+15],14,-660478335),f=h(f,l,d,c,u[g+4],20,-405537848),c=h(c,f,l,d,u[g+9],5,568446438),d=h(d,c,f,l,u[g+14],9,-1019803690),l=h(l,d,c,f,u[g+3],14,-187363961),f=h(f,l,d,c,u[g+8],20,1163531501),c=h(c,f,l,d,u[g+13],5,-1444681467),d=h(d,c,f,l,u[g+2],9,-51403784),l=h(l,d,c,f,u[g+7],14,1735328473),f=h(f,l,d,c,u[g+12],20,-1926607734),c=m(c,f,l,d,u[g+5],4,-378558),d=m(d,c,f,l,u[g+8],11,-2022574463),l=m(l,d,c,f,u[g+11],16,1839030562),f=m(f,l,d,c,u[g+14],23,-35309556),c=m(c,f,l,d,u[g+1],4,-1530992060),d=m(d,c,f,l,u[g+4],11,1272893353),l=m(l,d,c,f,u[g+7],16,-155497632),f=m(f,l,d,c,u[g+10],23,-1094730640),c=m(c,f,l,d,u[g+13],4,681279174),d=m(d,c,f,l,u[g+0],11,-358537222),l=m(l,d,c,f,u[g+3],16,-722521979),f=m(f,l,d,c,u[g+6],23,76029189),c=m(c,f,l,d,u[g+9],4,-640364487),d=m(d,c,f,l,u[g+12],11,-421815835),l=m(l,d,c,f,u[g+15],16,530742520),f=m(f,l,d,c,u[g+2],23,-995338651),c=v(c,f,l,d,u[g+0],6,-198630844),d=v(d,c,f,l,u[g+7],10,1126891415),l=v(l,d,c,f,u[g+14],15,-1416354905),f=v(f,l,d,c,u[g+5],21,-57434055),c=v(c,f,l,d,u[g+12],6,1700485571),d=v(d,c,f,l,u[g+3],10,-1894986606),l=v(l,d,c,f,u[g+10],15,-1051523),f=v(f,l,d,c,u[g+1],21,-2054922799),c=v(c,f,l,d,u[g+8],6,1873313359),d=v(d,c,f,l,u[g+15],10,-30611744),l=v(l,d,c,f,u[g+6],15,-1560198380),f=v(f,l,d,c,u[g+13],21,1309151649),c=v(c,f,l,d,u[g+4],6,-145523070),d=v(d,c,f,l,u[g+11],10,-1120210379),l=v(l,d,c,f,u[g+2],15,718787259),f=v(f,l,d,c,u[g+9],21,-343485551),c=c+b>>>0,f=f+w>>>0,l=l+_>>>0,d=d+y>>>0}return t.endian([c,f,l,d])};s._ff=function(e,t,r,n,o,a,s){var u=e+(t&r|~t&n)+(o>>>0)+s;return(u<<a|u>>>32-a)+t},s._gg=function(e,t,r,n,o,a,s){var u=e+(t&n|r&~n)+(o>>>0)+s;return(u<<a|u>>>32-a)+t},s._hh=function(e,t,r,n,o,a,s){var u=e+(t^r^n)+(o>>>0)+s;return(u<<a|u>>>32-a)+t},s._ii=function(e,t,r,n,o,a,s){var u=e+(r^(t|~n))+(o>>>0)+s;return(u<<a|u>>>32-a)+t},s._blocksize=16,s._digestsize=16,e.exports=function(e,r){if(void 0===e||null===e)throw new Error("Illegal argument "+e);var n=t.wordsToBytes(s(e,r));return r&&r.asBytes?n:r&&r.asString?a.bytesToString(n):t.bytesToHex(n)}}()},function(e,t){!function(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r={rotl:function(e,t){return e<<t|e>>>32-t},rotr:function(e,t){return e<<32-t|e>>>t},endian:function(e){if(e.constructor==Number)return 16711935&r.rotl(e,8)|4278255360&r.rotl(e,24);for(var t=0;t<e.length;t++)e[t]=r.endian(e[t]);return e},randomBytes:function(e){for(var t=[];e>0;e--)t.push(Math.floor(256*Math.random()));return t},bytesToWords:function(e){for(var t=[],r=0,n=0;r<e.length;r++,n+=8)t[n>>>5]|=e[r]<<24-n%32;return t},wordsToBytes:function(e){for(var t=[],r=0;r<32*e.length;r+=8)t.push(e[r>>>5]>>>24-r%32&255);return t},bytesToHex:function(e){for(var t=[],r=0;r<e.length;r++)t.push((e[r]>>>4).toString(16)),t.push((15&e[r]).toString(16));return t.join("")},hexToBytes:function(e){for(var t=[],r=0;r<e.length;r+=2)t.push(parseInt(e.substr(r,2),16));return t},bytesToBase64:function(e){for(var r=[],n=0;n<e.length;n+=3)for(var o=e[n]<<16|e[n+1]<<8|e[n+2],a=0;a<4;a++)8*n+6*a<=8*e.length?r.push(t.charAt(o>>>6*(3-a)&63)):r.push("=");return r.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\\/]/gi,"");for(var r=[],n=0,o=0;n<e.length;o=++n%4)0!=o&&r.push((t.indexOf(e.charAt(n-1))&Math.pow(2,-2*o+8)-1)<<2*o|t.indexOf(e.charAt(n))>>>6-2*o);return r}};e.exports=r}()},function(e,t){function r(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}function n(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&r(e.slice(0,0))}/*!\n * Determine if an object is a Buffer\n *\n * @author   Feross Aboukhadijeh <feross@feross.org> <http://feross.org>\n * @license  MIT\n */\ne.exports=function(e){return null!=e&&(r(e)||n(e)||!!e._isBuffer)}},function(module,exports,__webpack_require__){"use strict";function b64DecodeUnicode(e){return decodeURIComponent(atob(e).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))}function getResult(meta){try{meta.result=eval("("+b64DecodeUnicode(meta.result)+")")}catch(e){}return 0===meta.status?{success:!0,result:meta.result}:{status:meta.status,success:!1,msg:meta.msg}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=getResult}]);',r.p+"fbf3e696ada013c4dae6.worker.js")}},function(e,t,r){"use strict";var n=window.URL||window.webkitURL;e.exports=function(e,t){try{try{var r;try{var o=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;r=new o,r.append(e),r=r.getBlob()}catch(t){r=new Blob([e])}return new Worker(n.createObjectURL(r))}catch(t){return new Worker("data:application/javascript,"+encodeURIComponent(e))}}catch(e){if(!t)throw Error("Inline worker is not supported");return new Worker(t)}}},function(e,t,r){"use strict";function n(){var e=null,t=null,r=new Promise(function(r,n){e=r,t=n});return r.resolve=e,r.reject=t,r}Object.defineProperty(t,"__esModule",{value:!0}),t.createDefaultPromise=n}])});